<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="holiday.png">

<title>Piano Ferie 2026</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Firebase SDK v9+ (modular) -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
  import { getDatabase, ref, set, get, onValue, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBupKv4YgQNogpZHgOKkpeuxESev1fP5Ew",
    authDomain: "planner-ferie.firebaseapp.com",
    projectId: "planner-ferie",
    storageBucket: "planner-ferie.firebasestorage.app",
    messagingSenderId: "511639574108",
    appId: "1:511639574108:web:2def4d68d7b12ea09a7899",
    measurementId: "G-VBTS0DWXWM",
    databaseURL: "https://planner-ferie-default-rtdb.europe-west1.firebasedatabase.app/"
  };


  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  window.firebaseDB = {
    ref: (path) => ref(database, path),
    set: set,
    get: get,
    onValue: onValue,
    remove: remove
  };

  window.addEventListener('DOMContentLoaded', () => {
    if (window.initApp) {
      window.initApp();
    }
  });
</script>

<style>
/* ================= VARIABLES ================= */
:root {
    --bg-primary: #f3f6f9;
    --bg-secondary: #fff;
    --text-primary: #172754;
    --text-secondary: #374151;
    --border-color: #d5dbe7;
    --hover-bg: #EFF3FE;
    --accent-blue: #172754;
    --accent-blue-dark: #3b82f6;
    --header-gradient-start: #3A404C;
    --header-gradient-end: #2D343F;
    --title-blue: #172754;
}

[data-theme="dark"] {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --border-color: #334155;
    --hover-bg: #334155;
    --accent-blue: #172754;
    --accent-blue-dark: #93c5fd;
    --header-gradient-start: #1e293b;
    --header-gradient-end: #0f172a;
    --title-blue: #93c5fd;
}

/* ================= BASE ================= */
body{
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",
               "Segoe UI",Roboto,system-ui,sans-serif;
    background:var(--bg-primary);
    margin:0;
    padding:20px;
    color:var(--text-primary);
    transition:background 0.3s ease, color 0.3s ease;
}

/* ================= LOGO HEADER ================= */
.logo-box{
    width:100%;
    margin-bottom:8px;
    padding:20px 0;
    text-align:center;
    background:linear-gradient(180deg, var(--header-gradient-start), var(--header-gradient-end));
    border-radius:12px;
}
.logo-img{
    height:70px;
    width:auto;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.5));
}

/* Dark Mode Toggle */
.dark-mode-toggle{
    display:flex;
    justify-content:center;
    margin:10px 0 16px;
}
.theme-switch{
    background:var(--bg-secondary);
    border:1px solid var(--border-color);
    border-radius:999px;
    padding:6px 14px;
    cursor:pointer;
    color:var(--text-secondary);
    font-size:13px;
    display:flex;
    align-items:center;
    gap:8px;
    transition:all 0.3s ease;
}
.theme-switch:hover{
    background:var(--hover-bg);
    border-color:var(--accent-blue);
}
.theme-icon{
    width:16px;
    height:16px;
    display:flex;
    align-items:center;
    justify-content:center;
}

@media(max-width:768px){
    .logo-img{height:48px}
}

/* ================= TITOLI ================= */
h1, h2, h3{
    color:var(--title-blue);
}
h1{
    text-align:center;
    margin:10px 0 14px;
}

/* ================= HEADER NAV ================= */
.calendar-header{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:20px;
    margin-bottom:20px;
}
.nav-btn{
    padding:12px 16px;
    border-radius:999px;
    border:1px solid var(--border-color);
    background:var(--bg-secondary);
    color:var(--text-primary);
    cursor:pointer;
    transition:all 0.2s ease;
    font-weight:600;
    font-size:15px;
    display:flex;
    align-items:center;
    justify-content:center;
}
.nav-btn svg{
    display:block;
}
.nav-btn:hover{
    background:var(--accent-blue);
    color:#FDFCF0;
    border-color:var(--accent-blue);
    transform:translateY(-1px);
    box-shadow:0 4px 8px rgba(0,0,0,.1);
}
.nav-btn:hover svg{
    stroke:#FDFCF0;
}
.month-label{
    font-weight:700;
    color:var(--title-blue);
    font-size:22px;
    min-width:180px;
    text-align:center;
}

/* ================= VIEW ================= */
.view-mode-bar{
    display:flex;
    justify-content:center;
    gap:10px;
    margin:0 0 30px;
    flex-wrap:wrap;
}
.view-btn{
    padding:10px 20px;
    border-radius:999px;
    border:1px solid var(--border-color);
    background:var(--bg-secondary);
    color:var(--text-primary);
    cursor:pointer;
    transition:all 0.2s ease;
    font-size:15px;
    font-weight:500;
}
.view-btn:hover{
    background:var(--hover-bg);
    transform:translateY(-1px);
    box-shadow:0 2px 4px rgba(0,0,0,.08);
}
.view-btn.active{
    background:var(--accent-blue);
    color:#ffffff;
    border-color:var(--accent-blue);
    font-weight:600;
    box-shadow:0 4px 8px rgba(96,165,250,.3);
}

/* ================= PAGE LAYOUT ================= */
.page-wrapper{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:28px;
}

/* ================= STATISTICHE CARD ================= */
.stats-row{
    width:70%;
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
    gap:12px;
    margin-bottom:16px;
}
.stat-card{
    background:var(--bg-secondary);
    padding:14px 16px;
    border-radius:10px;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    border-left:3px solid var(--accent-blue);
}
.stat-label{
    font-size:10px;
    color:var(--text-secondary);
    text-transform:uppercase;
    letter-spacing:0.6px;
    margin-bottom:6px;
    font-weight:600;
}
.stat-value{
    font-size:24px;
    font-weight:700;
    color:var(--title-blue);
}
.stat-subvalue{
    font-size:12px;
    color:var(--text-secondary);
    margin-top:3px;
}

/* ================= DASHBOARD ================= */
.dashboard-row{
    width:70%;
    display:flex;
    gap:3%;
}
.dashboard-box{
    width:32%;
    background:var(--bg-secondary);
    padding:18px;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.dashboard-box h3{
    margin:0 0 14px 0;
    color:var(--title-blue);
    font-size:17px;
}
.chart-box{
    width:68%;
    background:var(--bg-secondary);
    padding:18px;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.chart-box h3{
    margin:0 0 14px 0;
    color:var(--title-blue);
    font-size:17px;
}

/* Filtri Utenti */
.chart-filters{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:14px;
    padding-bottom:10px;
    border-bottom:1px solid var(--border-color);
}
.filter-chip{
    padding:6px 12px;
    border-radius:999px;
    border:1px solid var(--border-color);
    background:var(--bg-secondary);
    color:var(--text-primary);
    cursor:pointer;
    font-size:12px;
    transition:all 0.2s ease;
    display:flex;
    align-items:center;
    gap:6px;
}
.filter-chip:hover{
    background:var(--hover-bg);
    transform:translateY(-1px);
}
.filter-chip.active{
    background:var(--accent-blue);
    color:#ffffff;
    border-color:var(--accent-blue);
}
.filter-chip-color{
    width:10px;
    height:10px;
    border-radius:50%;
}

.chart-box canvas{
    height:320px!important;
    max-height:320px;
}

/* ================= TOTALI TABLE ================= */
#dashboardTable{
    width:100%;
    border-collapse:collapse;
    font-size:15px;
}
#dashboardTable th{
    background:#EFF3FE;
    color:var(--title-blue);
    border:1px solid #c7d2fe;
    padding:12px 10px;
    font-weight:700;
    text-align:center;
    font-size:14px;
}
#dashboardTable td{
    border:1px solid var(--border-color);
    padding:12px 10px;
    text-align:center;
    background:var(--bg-secondary);
    color:var(--text-primary);
    transition:all 0.2s ease;
}
#dashboardTable td:first-child{
    text-align:left;
    font-weight:700;
    color:var(--text-secondary);
    font-size:15px;
}
#dashboardTable tbody tr{
    cursor:pointer;
}

/* ================= DASHBOARD TABLE HOVER - DARK ================= */
[data-theme="dark"] #dashboardTable tbody tr:hover{
    background:#173B54;          /* scuro ma distinto */
    transform:scale(1.01);
}

[data-theme="dark"] #dashboardTable tbody tr:hover td{
    background:#173B54;
}
[data-theme="dark"] #dashboardTable tbody tr:hover td{
    color:#93c5fd;
}

/* ================= DASHBOARD TABLE ROW HOVER - LIGHT ================= */
#dashboardTable tbody tr:hover td{
    background:#EFF3FE;          /* oppure var(--hover-bg) */
    color:#172754;
}


#dashboardTable tbody tr:hover td{
    color:#173B54;
}





#dashboardTable td:nth-child(2),
#dashboardTable td:nth-child(3){
    font-weight:700;
    color:var(--accent-blue-dark);
    font-size:15px;
}

/* ================= PLANNER ================= */
.planner-container{width:70%}
#plannersContainer{
    display:flex;
    flex-direction:column;
    gap:22px;
}

.planner-month-title{
    font-size:20px;
    font-weight:700;
    color:var(--title-blue);
    margin-bottom:12px;
    padding:10px 0;
    text-align:center;
    background:var(--bg-secondary);
    border-radius:8px 8px 0 0;
    border-bottom:2px solid var(--accent-blue);
}

.planner-box{
    border-radius:14px;
    overflow-x:auto;
    overflow-y:hidden;
    background:var(--bg-secondary);
    box-shadow:0 4px 14px rgba(0,0,0,.08);
    -webkit-overflow-scrolling: touch;
}

table.planner{
    width:max-content;
    min-width:100%;
    border-collapse:collapse;
}

th,td{
    border:1px solid var(--border-color);
    padding:6px;
    height:38px;
    text-align:center;
    font-size:14px;
    color:var(--text-primary);
}

th.member-name,td.member-name{
    position:sticky;
    left:0;
    z-index:5;
    background:var(--bg-secondary);
    font-weight:700;
    text-align:left;
    padding-left:10px;
    white-space:nowrap;
}

.weekday-row th{
    background:#EFF3FE;
    color:var(--title-blue);
    font-weight:600;
    font-size:13px;
}
.holiday-col{
    background:#fde6b3;
    cursor:not-allowed;
}
[data-theme="dark"] .holiday-col{
    background:#174E54;
}
td.editable{cursor:pointer}
td.editable:hover{background:var(--hover-bg)}
td.full-day{background:#ffd6d6;color:#b30000;font-weight:600}
td.morning-partial{background:#d6ecff;color:#0b5ed7;font-weight:600}
td.afternoon-partial{background:#e6dbff;color:#4b2dbf;font-weight:600}

[data-theme="dark"] td.full-day{background:#7f1d1d;color:#fca5a5}
[data-theme="dark"] td.morning-partial{background:#1e3a8a;color:#93c5fd}
[data-theme="dark"] td.afternoon-partial{background:#4c1d95;color:#c4b5fd}

/* ================= MODALE ================= */
.modal-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    backdrop-filter:blur(6px);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
}
.modal-panel{
    background:var(--bg-secondary);
    border-radius:18px;
    padding:20px 22px;
    width:420px;
}
.modal-title{
    font-weight:700;
    font-size:18px;
    color:var(--text-primary);
}
.modal-subtitle{
    font-size:13px;
    color:var(--text-secondary);
    margin-bottom:12px;
}
.btn-full-day{
    width:100%;
    padding:10px;
    border-radius:999px;
    border:1px solid #fca5a5;
    background:#fee2e2;
    color:#b30000;
    font-weight:600;
    cursor:pointer;
    margin-bottom:14px;
}
[data-theme="dark"] .btn-full-day{
    background:#7f1d1d;
    border-color:#991b1b;
    color:#fca5a5;
}
.modal-section{margin-bottom:12px}
.modal-section-title{
    font-size:13px;
    font-weight:600;
    margin-bottom:6px;
    color:var(--text-primary);
}
.modal-hours{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
}
.hour-btn{
    padding:6px 12px;
    border-radius:999px;
    border:1px solid var(--border-color);
    background:var(--bg-secondary);
    color:var(--text-primary);
    cursor:pointer;
    font-size:13px;
}
.hour-btn:hover{
    background:var(--hover-bg);
}
.modal-footer{
    display:flex;
    justify-content:space-between;
    margin-top:10px;
}
.remove-link{color:#dc2626;font-size:13px;cursor:pointer}
[data-theme="dark"] .remove-link{color:#f87171}
.cancel-btn{
    padding:6px 14px;
    border-radius:999px;
    border:none;
    background:var(--hover-bg);
    color:var(--text-primary);
    cursor:pointer;
}

/* ================= LOADING INDICATOR ================= */
.loading-overlay{
    position:fixed;
    inset:0;
    background:rgba(255,255,255,0.9);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
}
[data-theme="dark"] .loading-overlay{
    background:rgba(15,23,42,0.9);
}
.loading-spinner{
    width:50px;
    height:50px;
    border:4px solid var(--border-color);
    border-top:4px solid var(--accent-blue);
    border-radius:50%;
    animation:spin 1s linear infinite;
}
@keyframes spin{
    0%{transform:rotate(0deg)}
    100%{transform:rotate(360deg)}
}

/* ================= RESPONSIVE ================= */
@media(max-width:1200px){
    .planner-container,.dashboard-row,.stats-row{width:100%}
}
@media(max-width:900px){
    .dashboard-row{
        flex-direction:column;
        gap:16px;
    }
    .dashboard-box,.chart-box{width:100%}
    .chart-box canvas{height:300px!important}
}
@media(max-width:768px){
    th,td{font-size:12px;height:32px}
    .chart-box canvas{height:280px!important}
    .stat-value{font-size:20px}
    .month-label{font-size:18px}
    .nav-btn{padding:10px 18px;font-size:14px}
    .view-btn{padding:8px 16px;font-size:14px}
    #dashboardTable{font-size:13px}
    #dashboardTable th{font-size:12px;padding:10px 8px}
    #dashboardTable td{padding:10px 8px}
}

/* ================= DARK MODE TH ================= */
[data-theme="dark"] th{
    background:#173B54;
    color:#f1f5f9;
    border-color:#334155;
}

[data-theme="dark"] #dashboardTable th{
    background:#173B54;
    color:#f1f5f9;
}

</style>
</head>

<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

<header class="logo-box">
    <img src="logo_dataexpert.png" alt="Dataexpert" class="logo-img">
</header>

<!-- Dark Mode Toggle -->
<div class="dark-mode-toggle">
    <button class="theme-switch" onclick="toggleDarkMode()">
        <span class="theme-icon" id="themeIcon">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </span>
        <span id="themeText">Dark</span>
    </button>
</div>

<h1>Planner Annuale 2026</h1>

<div class="calendar-header">
    <button class="nav-btn" onclick="prevMonth()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </button>
    <div class="month-label" id="monthLabel"></div>
    <button class="nav-btn" onclick="nextMonth()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </button>
</div>

<div class="view-mode-bar">
    <button class="view-btn active" onclick="setView('month',this)">Mese</button>
    <button class="view-btn" onclick="setView('quarter',this)">Trimestre</button>
    <button class="view-btn" onclick="setView('half',this)">Semestre</button>
    <button class="view-btn" onclick="setView('year',this)">Anno</button>
    <button class="view-btn" onclick="exportToExcel()">⬇︎ Excel</button>
</div>

<div class="page-wrapper" id="pageWrapper">

    <!-- Statistiche Cards -->
    <div class="stats-row" id="statsRow">
        <div class="stat-card">
            <div class="stat-label">Totale Giorni</div>
            <div class="stat-value" id="totalDays">0</div>
            <div class="stat-subvalue" id="totalHours">0 ore</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Media per Persona</div>
            <div class="stat-value" id="avgDays">0</div>
            <div class="stat-subvalue" id="avgHours">0 ore</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Mese con Più Ferie</div>
            <div class="stat-value" id="peakMonth">-</div>
            <div class="stat-subvalue" id="peakDays">0 giorni</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Utente con Più Ferie</div>
            <div class="stat-value" id="topUser">-</div>
            <div class="stat-subvalue" id="topUserDays">0 giorni</div>
        </div>
    </div>

    <!-- dashboard -->
    <div class="dashboard-row" id="dashboardRow">
        <div class="dashboard-box">
            <h3>Totali per Utente</h3>
            <table id="dashboardTable">
                <thead>
                    <tr>
                        <th>Utente</th>
                        <th>Giorni</th>
                        <th>Ore</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="chart-box">
            <h3>Giorni di Ferie per Mese</h3>
            <div class="chart-filters" id="chartFilters"></div>
            <canvas id="chart"></canvas>
        </div>
    </div>

    <!-- planner -->
    <div class="planner-container">
        <div id="plannersContainer"></div>
    </div>

</div>

<!-- MODALE -->
<div id="modal" class="modal-overlay" onclick="closeModal()">
  <div class="modal-panel" onclick="event.stopPropagation()">
    <div class="modal-title">Imposta ferie</div>
    <div class="modal-subtitle" id="modalDate"></div>

    <button class="btn-full-day" onclick="applyValue('8')">Giornata intera · 8 ore</button>

    <div class="modal-section">
        <div class="modal-section-title">Mattina (08:00 – 13:00)</div>
        <div class="modal-hours">
            <button class="hour-btn" onclick="applyValue('1 M')">1 ora</button>
            <button class="hour-btn" onclick="applyValue('2 M')">2 ore</button>
            <button class="hour-btn" onclick="applyValue('3 M')">3 ore</button>
            <button class="hour-btn" onclick="applyValue('4 M')">4 ore</button>
            <button class="hour-btn" onclick="applyValue('5 M')">5 ore</button>
        </div>
    </div>

    <div class="modal-section">
        <div class="modal-section-title">Pomeriggio (14:00 – 19:00)</div>
        <div class="modal-hours">
            <button class="hour-btn" onclick="applyValue('1 P')">1 ora</button>
            <button class="hour-btn" onclick="applyValue('2 P')">2 ore</button>
            <button class="hour-btn" onclick="applyValue('3 P')">3 ore</button>
            <button class="hour-btn" onclick="applyValue('4 P')">4 ore</button>
            <button class="hour-btn" onclick="applyValue('5 P')">5 ore</button>
        </div>
    </div>

    <div class="modal-footer">
        <div class="remove-link" onclick="applyValue('')">Rimuovi valore</div>
        <button class="cancel-btn" onclick="closeModal()">Annulla</button>
    </div>
  </div>
</div>

<script>
/* ================= JS CON FIREBASE ================= */
const users=["Damiano","Gianluca","Gregorio","Leonardo","Samuela","Simone"];
const months=[
 {n:"Gennaio",s:"Gen",d:31,h:[1,6]},
 {n:"Febbraio",s:"Feb",d:28,h:[]},
 {n:"Marzo",s:"Mar",d:31,h:[]},
 {n:"Aprile",s:"Apr",d:30,h:[25]},
 {n:"Maggio",s:"Mag",d:31,h:[1]},
 {n:"Giugno",s:"Giu",d:30,h:[2]},
 {n:"Luglio",s:"Lug",d:31,h:[]},
 {n:"Agosto",s:"Ago",d:31,h:[15]},
 {n:"Settembre",s:"Set",d:30,h:[]},
 {n:"Ottobre",s:"Ott",d:31,h:[]},
 {n:"Novembre",s:"Nov",d:30,h:[1]},
 {n:"Dicembre",s:"Dic",d:31,h:[8,25,26]}
];

let currentMonth = new Date().getMonth(); // Mese corrente dinamico (0=Gennaio, 1=Febbraio, etc.)
let viewMode="month";
let activeCell=null;
let chart=null;
let dataCache = {};
let activeFilters = new Set(users);

const parseHours=v=>!v?0:(v==="8"?8:parseInt(v));
const parseDays=v=>parseHours(v)/8;

// Palette colori pastello ben distinti per gli utenti
const userColors = {
    "Damiano": { bg: 'rgba(96, 165, 250, 0.75)', border: '#60a5fa', point: '#3b82f6' },     // Blu cielo
    "Gianluca": { bg: 'rgba(251, 146, 60, 0.75)', border: '#fb923c', point: '#f97316' },   // Arancione
    "Gregorio": { bg: 'rgba(248, 113, 113, 0.75)', border: '#f87171', point: '#ef4444' },  // Rosso/Rosa
    "Leonardo": { bg: 'rgba(74, 222, 128, 0.75)', border: '#4ade80', point: '#22c55e' },   // Verde
    "Samuela": { bg: 'rgba(196, 181, 253, 0.75)', border: '#c4b5fd', point: '#a78bfa' },   // Viola chiaro
    "Simone": { bg: 'rgba(253, 224, 71, 0.75)', border: '#fde047', point: '#facc15' }      // Giallo
};

// ================= DARK MODE =================

function toggleDarkMode(){
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    
    if(newTheme === 'dark'){
        icon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
        text.textContent = 'Light';
    } else {
        icon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
        text.textContent = 'Dark';
    }
    
    renderChart();
}

function loadTheme(){
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    const icon = document.getElementById('themeIcon');
    const text = document.getElementById('themeText');
    
    if(savedTheme === 'dark'){
        icon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
        text.textContent = 'Light';
    }
}

// ================= FIREBASE FUNCTIONS =================

async function getFirebaseValue(key) {
    if (dataCache[key] !== undefined) {
        return dataCache[key];
    }
    
    try {
        const dbRef = window.firebaseDB.ref(`ferie2026/${key}`);
        const snapshot = await window.firebaseDB.get(dbRef);
        const value = snapshot.exists() ? snapshot.val() : "";
        dataCache[key] = value;
        return value;
    } catch (error) {
        console.error("Errore lettura Firebase:", error);
        return "";
    }
}

async function setFirebaseValue(key, value) {
    try {
        const dbRef = window.firebaseDB.ref(`ferie2026/${key}`);
        if (value) {
            await window.firebaseDB.set(dbRef, value);
            dataCache[key] = value;
        } else {
            await window.firebaseDB.remove(dbRef);
            delete dataCache[key];
        }
    } catch (error) {
        console.error("Errore scrittura Firebase:", error);
    }
}

function setupRealtimeListener() {
    const dbRef = window.firebaseDB.ref('ferie2026');
    window.firebaseDB.onValue(dbRef, (snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            dataCache = data || {};
            if (!activeCell) {
                render();
            }
        }
    });
}

async function loadAllData() {
    try {
        const dbRef = window.firebaseDB.ref('ferie2026');
        const snapshot = await window.firebaseDB.get(dbRef);
        if (snapshot.exists()) {
            dataCache = snapshot.val();
        }
    } catch (error) {
        console.error("Errore caricamento dati:", error);
    }
}

// ================= STATISTICHE =================

function calculateStats(){
    let totalDays = 0;
    let userDays = {};
    let monthDays = Array(12).fill(0);
    
    users.forEach(u => {
        userDays[u] = 0;
        months.forEach((m, mi) => {
            for(let d = 1; d <= m.d; d++){
                const key = `${u}-${mi}-${d}`;
                const days = parseDays(dataCache[key]);
                totalDays += days;
                userDays[u] += days;
                monthDays[mi] += days;
            }
        });
    });
    
    document.getElementById('totalDays').textContent = totalDays.toFixed(1);
    document.getElementById('totalHours').textContent = (totalDays * 8).toFixed(0) + ' ore';
    
    const avgDays = totalDays / users.length;
    document.getElementById('avgDays').textContent = avgDays.toFixed(1);
    document.getElementById('avgHours').textContent = (avgDays * 8).toFixed(0) + ' ore';
    
    const maxMonthIdx = monthDays.indexOf(Math.max(...monthDays));
    document.getElementById('peakMonth').textContent = months[maxMonthIdx].n;
    document.getElementById('peakDays').textContent = monthDays[maxMonthIdx].toFixed(1) + ' giorni';
    
    const maxUser = Object.keys(userDays).reduce((a, b) => userDays[a] > userDays[b] ? a : b);
    document.getElementById('topUser').textContent = maxUser;
    document.getElementById('topUserDays').textContent = userDays[maxUser].toFixed(1) + ' giorni';
}

// ================= FILTRI UTENTI =================

function renderFilters(){
    const container = document.getElementById('chartFilters');
    container.innerHTML = '';
    
    users.forEach(u => {
        const chip = document.createElement('div');
        chip.className = 'filter-chip' + (activeFilters.has(u) ? ' active' : '');
        chip.onclick = () => toggleFilter(u);
        
        const color = document.createElement('div');
        color.className = 'filter-chip-color';
        color.style.background = userColors[u].border;
        
        chip.appendChild(color);
        chip.appendChild(document.createTextNode(u));
        container.appendChild(chip);
    });
}

function toggleFilter(user){
    if(activeFilters.has(user)){
        activeFilters.delete(user);
    } else {
        activeFilters.add(user);
    }
    renderFilters();
    renderChart();
}

// ================= GRAFICO =================

function renderChart(){
    const ctx = document.getElementById('chart');
    if(chart) chart.destroy();
    
    const filteredUsers = users.filter(u => activeFilters.has(u));
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    const colors = {
        textColor: isDark ? '#cbd5e1' : '#6b7280',
        gridColor: isDark ? '#334155' : '#e5e7eb',
        tooltipBg: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.98)',
        tooltipTitle: isDark ? '#f1f5f9' : '#172754',
        tooltipBody: isDark ? '#cbd5e1' : '#374151',
        tooltipBorder: isDark ? '#334155' : '#d1d5db'
    };
    
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months.map(m => m.s),
            datasets: filteredUsers.map(u => ({
                label: u,
                data: months.map((m, mi) => {
                    let days = 0;
                    for(let d = 1; d <= m.d; d++){
                        const key = `${u}-${mi}-${d}`;
                        days += parseDays(dataCache[key]);
                    }
                    return days;
                }),
                backgroundColor: userColors[u].bg.replace('0.75', '0.3'),
                borderColor: userColors[u].border,
                borderWidth: 3,
                pointBackgroundColor: userColors[u].point,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointHoverBorderWidth: 3,
                fill: true,
                tension: 0.4
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { 
                mode: 'point',
                intersect: true
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 16,
                        font: {
                            size: 13,
                            family: '-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto',
                            weight: '500'
                        },
                        color: colors.textColor,
                        boxWidth: 10,
                        boxHeight: 10
                    }
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: colors.tooltipBg,
                    titleColor: colors.tooltipTitle,
                    bodyColor: colors.tooltipBody,
                    borderColor: colors.tooltipBorder,
                    borderWidth: 2,
                    padding: 14,
                    titleFont: { 
                        size: 14, 
                        weight: 'bold',
                        family: '-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto'
                    },
                    bodyFont: { 
                        size: 13,
                        family: '-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto'
                    },
                    bodySpacing: 5,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: (context) => {
                            const days = context.parsed.y.toFixed(1);
                            const hours = (context.parsed.y * 8).toFixed(0);
                            return ` ${context.dataset.label}: ${days} giorni (${hours}h)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { 
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        color: colors.textColor,
                        font: { 
                            size: 13, 
                            weight: '600',
                            family: '-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto'
                        },
                        padding: 8
                    }
                },
                y: {
                    beginAtZero: true,
                    grace: '5%',
                    grid: {
                        color: colors.gridColor,
                        drawBorder: false,
                        lineWidth: 1.5
                    },
                    border: {
                        display: false
                    },
                    ticks: {
                        color: colors.textColor,
                        font: { 
                            size: 12,
                            weight: '500',
                            family: '-apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto'
                        },
                        callback: (value) => {
                            if (value === 0) return '0';
                            return value.toFixed(0) + ' gg';
                        },
                        stepSize: 2,
                        padding: 10
                    }
                }
            }
        }
    });
}

// ================= FUNZIONI RENDER =================

function setView(v,btn){
    viewMode=v;
    document.querySelectorAll(".view-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    // Stats e dashboard sempre in alto
    const wrapper=document.getElementById("pageWrapper");
    const stats=document.getElementById("statsRow");
    const dash=document.getElementById("dashboardRow");
    const planner=document.querySelector(".planner-container");

    // Assicurati che siano sempre nell'ordine corretto
    wrapper.insertBefore(stats, wrapper.firstChild);
    if(dash.nextSibling !== planner){
        wrapper.insertBefore(dash, planner);
    }
    
    render();
}

function render(){
    renderPlanner();
    renderDashboard();
    renderChart();
    calculateStats();
    renderFilters();
}

function renderPlanner(){
    const cont=document.getElementById("plannersContainer");
    cont.innerHTML="";

    document.getElementById("monthLabel").textContent=
        months[currentMonth].n+" 2026";

    let idxs=[currentMonth];
    if(viewMode==="quarter"){
        const s=Math.floor(currentMonth/3)*3;
        idxs=[s,s+1,s+2];
    }
    if(viewMode==="half"){
        idxs=currentMonth<6?[0,1,2,3,4,5]:[6,7,8,9,10,11];
    }
    if(viewMode==="year"){
        idxs=[...Array(12).keys()];
    }

    idxs.forEach(mi=>{
        const m=months[mi];
        
        // Aggiungo titolo mese sopra ogni planner
        let html='';
        if(viewMode !== 'month'){
            html+=`<div class="planner-month-title">${m.n} 2026</div>`;
        }
        
        html+=`<div class="planner-box"><table class="planner"><thead>
        <tr class="weekday-row">
            <th class="member-name" rowspan="2">Utenti</th>`;

        for(let d=1;d<=m.d;d++){
            html+=`<th>${["dom","lun","mar","mer","gio","ven","sab"][new Date(2026,mi,d).getDay()]}</th>`;
        }

        html+=`</tr><tr>`;
        for(let d=1;d<=m.d;d++){
            const wd=new Date(2026,mi,d).getDay();
            html+=`<th class="${wd===0||wd===6||m.h.includes(d)?"holiday-col":""}">${d}</th>`;
        }
        html+=`</tr></thead><tbody>`;

        users.forEach(u=>{
            html+=`<tr><td class="member-name">${u}</td>`;
            for(let d=1;d<=m.d;d++){
                const wd=new Date(2026,mi,d).getDay();
                const key=`${u}-${mi}-${d}`;
                const v=dataCache[key]||"";
                if(wd===0||wd===6||m.h.includes(d)){
                    html+=`<td class="holiday-col"></td>`;
                }else{
                    let cls="editable";
                    if(v==="8")cls+=" full-day";
                    if(v.endsWith("M"))cls+=" morning-partial";
                    if(v.endsWith("P"))cls+=" afternoon-partial";
                    html+=`<td class="${cls}" onclick="openModal(this,'${key}',${d},${mi})">${v}</td>`;
                }
            }
            html+=`</tr>`;
        });

        html+=`</tbody></table></div>`;
        cont.insertAdjacentHTML("beforeend",html);
    });
}

function renderDashboard(){
    const tb=document.querySelector("#dashboardTable tbody");
    tb.innerHTML="";
    users.forEach(u=>{
        let days=0;
        months.forEach((m,mi)=>{
            for(let d=1;d<=m.d;d++){
                const key = `${u}-${mi}-${d}`;
                days+=parseDays(dataCache[key]);
            }
        });
        tb.innerHTML+=`<tr>
            <td>${u}</td>
            <td>${days.toFixed(1)}</td>
            <td>${(days * 8).toFixed(0)}</td>
        </tr>`;
    });
}

// ================= MODAL FUNCTIONS =================

function openModal(td,key,day,month){
    activeCell={td,key};
    document.getElementById("modalDate").textContent=
        `${day} ${months[month].n} 2026`;
    document.getElementById("modal").style.display="flex";
}

function closeModal(){
    document.getElementById("modal").style.display="none";
    activeCell=null;
}

async function applyValue(v){
    if(!activeCell)return;
    
    activeCell.td.textContent=v;
    await setFirebaseValue(activeCell.key, v);
    closeModal();
    render();
}

// ================= NAVIGATION =================

function nextMonth(){
    currentMonth=(currentMonth+1)%12;
    render();
}

function prevMonth(){
    currentMonth=(currentMonth+11)%12;
    render();
}

// ================= EXPORT TO EXCEL =================

function exportToExcel(){
    const wb=XLSX.utils.book_new();
    months.forEach((m,mi)=>{
        const aoa=[["Utente",...Array.from({length:m.d},(_,i)=>i+1)]];
        users.forEach(u=>{
            const row=[u];
            for(let d=1;d<=m.d;d++){
                const key = `${u}-${mi}-${d}`;
                row.push(dataCache[key]||"");
            }
            aoa.push(row);
        });
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), m.n);
    });
    XLSX.writeFile(wb,"Planner_Ferie_2026.xlsx");
}

// ================= INIT APP =================

window.initApp = async function() {
    loadTheme();
    await loadAllData();
    setupRealtimeListener();
    render();
    document.getElementById('loadingOverlay').style.display = 'none';
};

if (window.firebaseDB) {
    window.initApp();
}
</script>

</body>
</html>

